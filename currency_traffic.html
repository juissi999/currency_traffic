<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Currency traffic</title>
</head>
<body>
    <h1>
        Currency traffic
        <div id="time"></div>
    </h1>
    <h2>
        Add new purchase
    </h2>
     <form name="input_sheet" method="post">
        Purchase: <input type="text" name="purchase" value="milk">
        Price: <input type="text" name="price" value="5">
        Type:
        <select id="selection">
        </select>
        <input id="addbutton" type="button" value="Add">
        <input id="randombutton" type="button" value="Add 100 random purchases">
    </form>
    <h2>
        Spendings 
    </h2>
    <p id="spending"></p>
    <p id="categoryspending"></p>
    <div style="width: 100%; display: table;">
      <div id="charts" style="display: table-row">
         <div id="chart" style="width: 450px; height: 250px; display:table-cell;"></div>
         <div id="chart2" style="width: 450px; height: 250px display:table-cell;;"></div>
      </div>
      <div id="charts" style="display: table-row">
        <div id="chart3" style="width: 450px; height: 250px display:table-cell;;"></div>
      </div>
    </div>
    <h2>
        Purchases
    </h2>
    <p id="data"></p>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
    (function () { //closure
        // code
        
        // load google charts
        google.charts.load('current', {'packages':['corechart']});

        // load stored datafile from memory
        // var data = loadData("data.json");
        var data = [];
        var dnow = new Date();
        var monthnames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    //    var date1 = new Date('April 1, 2018 03:24:00');
    //    var datediff = dnow-date1;
    //    var ONE_DAY = 1000 * 60 * 60 * 24;
    //    console.log(Math.round(datediff/ONE_DAY));
    //    console.log(Date().toString());
        var options = ["food", "service", "leisure", "item", "rent", "insurance"];
        document.getElementById("time").innerHTML = "Today is " + dnow.getDate() + 
                                                     "." + (dnow.getMonth() + 1)  + "." +
                                                     dnow.getFullYear();
        
        //document.getElementById("data").innerHTML = data;
        // generate selections for different categories
        addSelections(options);

        // if data exists at this point, calc and draw statistics
        if (data.length > 0) {
            updateStatistics();
        }
        
        $("#addbutton").click(function validateForm() {
            ptime = Date().toString();
            purchase = document.forms["input_sheet"]["purchase"].value;
            price = parseInt(document.forms["input_sheet"]["price"].value);
            selection = document.getElementById("selection")["value"];

            addPurchase(purchase, price, selection, ptime);
            updateStatistics();
        });

        $("#randombutton").click(function validateForm() {

          var howmanyrandom = 100
          for (var i=0;i<howmanyrandom;i++) {
             // generate random attributes
             var rnddate = new Date();
             rnddate.setTime(Math.round(rnddate.getTime()*Math.random()));
             var rndprice = Math.floor((Math.random() * 100) + 1)
             var rndselection = Math.floor((Math.random() * document.getElementById("selection").length))

             // insert purchase
             addPurchase("random", rndprice, document.getElementById("selection")[rndselection]["value"], rnddate);
          }
          updateStatistics();
        });
        
        function addPurchase(purchase, price, selection, datetime) {
            if (purchase.length > 0) {
               data.push([purchase, price, selection, datetime]);
            }
        }
        
        function updateStatistics(){
            printPurchases();
            calcTotalSpending();
            calcMonthlySpendins();
            
            spendingstr = "";
            if (data.length > 0) {
               var categoryspendings = calcCategorySpendings(data);
               var monthlyspendings = calcMonthlySpendins();
               printCharts(categoryspendings, monthlyspendings);

               // form categorical spending string
               for (var i=0;i<options.length;i++){
                   spendingstr += options[i] + ": " + categoryspendings[i] + " ";
               }
            } else {
               document.getElementById('chart').innerHTML = ""
               document.getElementById('chart2').innerHTML = ""
            }

            // update categorical spending string
            document.getElementById("categoryspending").innerHTML = spendingstr;
         }

        function calcMonthlySpendins(){
          var yearlyspendings = {}
          
          // TEMPORARY: add this year to the table
          yearlyspendings[dnow.getFullYear()] = {}
          for (j=0;j<dnow.getMonth()+1;j++) {
            yearlyspendings[dnow.getFullYear()][j] = 0
          }
 //         yearlyspendings[dnow.getFullYear()][dnow.getMonth()] = 0
          
          // find all months when purchases are made
          for (i=0;i<data.length;i++) {
            var ditem = new Date(data[i][3])
            var month = ditem.getMonth()
            var year = ditem.getFullYear()
            
            // check if year exists
            if (!(year in yearlyspendings)) {
               yearlyspendings[year] = {}
               
               // format all months to zero consumption ( TODO: possibly make a 
               // zeromonths, initialized dict of empty months and copy it to all
               // years.) Get rid of the duplicate of this in the beginning of func.
               for (j=0;j<12;j++) {
                  yearlyspendings[year][j] = 0
               }
            }
            
            if (month in yearlyspendings[year]) {
               yearlyspendings[year][month] += data[i][1]
//            } else {
 //              yearlyspendings[year][month] = data[i][1]
            }
          }
         return yearlyspendings;
        }
        
        function calcCategorySpendings(inputdata){
            // Calculate categorical spendings for each option for input values
            var categoryspendings = Array(options.length).fill(0);
            for (var i=0;i<options.length;i++){
                for (j=0;j<data.length;j++) {
                    if (options[i].valueOf() == inputdata[j][2].valueOf()) {
                        categoryspendings[i] += inputdata[j][1];
                    }
                }
            }
            return categoryspendings;
        }
        
        function calcTotalSpending(){
          // Calculate (and currently print) total spending for all products
          spending = 0;
          for (var i=0;i<data.length;i++){
            spending += parseInt(data[i][1]);
          }
            
          document.getElementById("spending").innerHTML = "Total: " + spending;
        }
        
        function addSelections(options){
            //Create and append the options
            for (var i = 0; i < options.length; i++) {
                var option = document.createElement("option");
                option.value = options[i];
                option.text = options[i];
                document.getElementById("selection").appendChild(option);
            }
        }
       
        function printCharts(categoryspendings, yearlyspendings){
            // parse categoryspendings
            var d = [['Category', 'Spending on category']];
            for (var i = 0; i < options.length; i++){
                d.push([options[i], categoryspendings[i]]);
            }
            
            // parse monthlyspendings for selected year
            var monthlyspendings = yearlyspendings[dnow.getFullYear()]
            var d2 = [["month", "spending"]]
            for (var key in monthlyspendings) {
               d2.push([monthnames[key], monthlyspendings[key]]) //parseInt(Number(key)+1)
            }
            
            // parse yearlyspendings
            var yearlyspending = 0
            var d3 = [["year", "spending"]]
            for (var key in yearlyspendings) {
               // loop and sum all monthly spendings across year
               for (var mkey in yearlyspendings[key]) {
                  yearlyspending += yearlyspendings[key][mkey]
               }
               d3.push([key, yearlyspending])
               yearlyspending = 0
            }
            
            var piedata = google.visualization.arrayToDataTable(d);
            var monthlydata = google.visualization.arrayToDataTable(d2);
            var yearlydata = google.visualization.arrayToDataTable(d3);
            
            var chart = new google.visualization.PieChart(document.getElementById('chart'));
            var chart2 = new google.visualization.LineChart(document.getElementById('chart2'));
            var chart3 = new google.visualization.LineChart(document.getElementById('chart3'));

            function selectYear() {
              // when user selects year set draw that years monthly graph
              var item = chart3.getSelection()[0];
              var year = d3[item.row][0];
              
            }

            chart.draw(piedata, {title: 'Categorical spending'});
            chart2.draw(monthlydata, {title: 'Monthly spending'});
            chart3.draw(yearlydata, {title: 'Spending by year'});
            google.visualization.events.addListener(chart3, 'select', selectYear); 
        }
                
        function printPurchases(){
            // Print the list of goodies bought
            var arraystr = "<table>";
            arraystr += "<tr><th>Item</th><th>Price</th><th>Type</th><th>Date</th></tr>"
            for (var i=data.length-1;i>-1;i--){
                arraystr += "<tr><td>"
                arraystr += data[i][0];
                arraystr += "</td><td>"
                arraystr += data[i][1];
                arraystr += "</td><td>"
                arraystr += data[i][2];
                arraystr += "</td><td>"
                arraystr += data[i][3];
                arraystr += "</td><td>"
                arraystr += "<input id=\"rb" + i + "\" type=\"button\" value=\"Remove item\">";
                arraystr += "</tr>";
            }
            arraystr += "</table>"
            document.getElementById("data").innerHTML = arraystr;
            
            // add click-function to each remove-button
            for (var i=0;i<data.length;i++){
                $("#rb" + i).click({p1:i}, function removeItem(event){
                    data.splice(event.data.p1, 1);
                    updateStatistics();
                });
            }
        }
    }());
    </script>
</body>

</html>