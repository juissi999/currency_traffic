<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Currency traffic</title>
</head>
<body>
    <h1>
        Currency traffic
        <div id="time"></div>
    </h1>
    <h2>
        Add new purchase
    </h2>
     <form name="input_sheet" method="post">
        Purchase: <input type="text" name="purchase" value="milk">
        Price: <input type="text" name="price" value="5">
        Type:
        <select id="selection">
        </select>
        <input id="commit-button" type="button" value="Add">
    </form>
    <h2>
        Spendings 
    </h2>
    <p id="spending"></p>
    <p id="categoryspending"></p>
    <div style="width: 100%; display: table;">
      <div id="charts" style="display: table-row">
         <div id="chart" style="width: 450px; height: 250px; display:table-cell;"></div>
         <div id="chart2" style="width: 450px; height: 250px display:table-cell;;"></div>
      </div>
    </div>
    <h2>
        Purchases
    </h2>
    <p id="data"></p>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
    (function () { //closure
        // code
        
        // load google charts
        google.charts.load('current', {'packages':['corechart']});

        // load stored datafile from memory
        // var data = loadData("data.json");
        var data = [];
        var dnow = new Date();
    //    var date1 = new Date('April 1, 2018 03:24:00');
    //    var datediff = dnow-date1;
    //    var ONE_DAY = 1000 * 60 * 60 * 24;
    //    console.log(Math.round(datediff/ONE_DAY));
    //    console.log(Date().toString());
        var options = ["food", "service", "leisure", "item", "rent", "insurance"];
        document.getElementById("time").innerHTML = "Today is " + dnow.getDate() + 
                                                     "." + (dnow.getMonth() + 1)  + "." +
                                                     dnow.getFullYear();
        
        document.getElementById("data").innerHTML = data;
        addSelections(options);

        // if data exists at this point, calc and draw statistics
        if (data.length > 0) {
            updateStatistics();
        }
        
        $("#commit-button").click(function validateForm() {
            ptime = Date().toString();
            purchase = document.forms["input_sheet"]["purchase"].value;
            price = parseInt(document.forms["input_sheet"]["price"].value);
            selection = document.getElementById("selection")["value"];
            
            if (purchase.length > 0) {
                data.push([purchase, price, selection, ptime]);
            }
            updateStatistics();
        });

        function updateStatistics(){
            printPurchases();
            calcTotalSpending();
            calcMonthlySpendins();
            
            if (data.length > 0) {
               var categoryspendings = calcCategorySpendings();
               var monthlyspendings = calcMonthlySpendins();
               drawChart(categoryspendings, monthlyspendings);
            } else {
               document.getElementById('chart').innerHTML = ""
               document.getElementById('chart2').innerHTML = ""
            }
        }
        
        function loadData(filename) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open('GET', filename, false); // last param: false=sync
            xmlHttp.send();
            return JSON.parse(xmlHttp.responseText);
        }
        
        function printPurchases(){
            // Print the list of goodies bought
            var arraystr = "<table>";
            arraystr += "<tr><th>Item</th><th>Price</th><th>Type</th><th>Date</th></tr>"
            for (var i=data.length-1;i>-1;i--){
                arraystr += "<tr><td>"
                arraystr += data[i][0];
                arraystr += "</td><td>"
                arraystr += data[i][1];
                arraystr += "</td><td>"
                arraystr += data[i][2];
                arraystr += "</td><td>"
                arraystr += data[i][3];
                arraystr += "</td><td>"
                arraystr += "<input id=\"rb" + i + "\" type=\"button\" value=\"Remove item\">";
                arraystr += "</tr>";
            }
            arraystr += "</table>"
            document.getElementById("data").innerHTML = arraystr;
            
            // add click-function to each remove-button
            for (var i=0;i<data.length;i++){
                $("#rb" + i).click({p1:i}, function removeItem(event){
                    data.splice(event.data.p1, 1);
                    updateStatistics();
                });
            }
        }

        function calcMonthlySpendins(){
          var monthlyspendings = {}
          
          // find all months when purchases are made
          for (i=0;i<data.length;i++) {
            var ditem = new Date(data[i][3])
            var month = ditem.getMonth()
            if (month in monthlyspendings) {
               monthlyspendings[month] += data[i][1]
            } else {
               monthlyspendings[month] = data[i][1]
            }
          }
         return monthlyspendings;
        }
        
        function calcCategorySpendings(){
            // Calculate (and currently print) categorical spendings for each option
            var categoryspendings = Array(options.length).fill(0);
            for (var i=0;i<options.length;i++){
                for (j=0;j<data.length;j++) {
                    if (options[i].valueOf() == data[j][2].valueOf()) {
                        categoryspendings[i] += data[j][1];
                    }
                }
            }
            spendingstr = "";
            for (var i=0;i<options.length;i++){
                spendingstr += options[i] + ": " + categoryspendings[i] + " ";
            }
            document.getElementById("categoryspending").innerHTML = spendingstr;
            return categoryspendings;
        }
        
         function calcTotalSpending(){
            // Calculate (and currently print) total spending for all products
            spending = 0;
            for (var i=0;i<data.length;i++){
                spending += parseInt(data[i][1]);
            }
            
            document.getElementById("spending").innerHTML = "Total: " + spending;
        }
        
        function addSelections(options){
            //Create and append the options
            for (var i = 0; i < options.length; i++) {
                var option = document.createElement("option");
                option.value = options[i];
                option.text = options[i];
                document.getElementById("selection").appendChild(option);
            }
        }

        function drawChart(categoryspendings, monthlyspendings){
            // parse categoryspendings
            var d = [['Category', 'Spending on category']];
            for (var i = 0; i < options.length; i++){
                d.push([options[i], categoryspendings[i]]);
            }
            
            // parse monthlyspendings
            var d2 = [["month", "spending"]]
            for (var key in monthlyspendings) {
               d2.push([key, monthlyspendings[key]])
            }
            
            var piedata = google.visualization.arrayToDataTable(d);
            var linedata = google.visualization.arrayToDataTable(d2);
            
            var chart = new google.visualization.PieChart(document.getElementById('chart'));
            var chart2 = new google.visualization.LineChart(document.getElementById('chart2'));
            chart.draw(piedata, {title: 'Categorical spending'});
            chart2.draw(linedata, {title: 'Monthly spending'});
        }

    //    function saveData(filename, data) {
    //        var xmlHttp = new XMLHttpRequest();
      //      xmlHttp.open('SET', filename, false); // last param: false=sync
        //    xmlHttp.send();
      //  }
    }());
    </script>
</body>

</html>