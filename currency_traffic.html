<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Currency traffic</title>
</head>
<body>
    <h1>
        Currency traffic
        <div id="time"></div>
    </h1>
    <h2>
        Add new purchase
    </h2>
     <form name="input_sheet" method="post">
        Purchase: <input type="text" name="purchase" value="milk">
        Price: <input type="text" name="price" value="5">
        Type:
        <select id="selection">
        </select>
        <input id="commit-button" type="button" value="Add">        
    </form>
    <h2>
        Spendings 
    </h2>
    <p id="spending"></p>
    <p id="categoryspending"></p>
    <p id="charts" style="width: 450px; height: 250px;"></p>
    <h2>
        Purchases
    </h2>
    <p id="data"></p>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
    (function () { //closure
        // code
        
        // load google charts
        google.charts.load('current', {'packages':['corechart']});

        // load stored datafile from memory
        // var data = loadData("data.json");
        var data = [];
        var dnow = new Date();
    //    var date1 = new Date('April 1, 2018 03:24:00');
    //    var datediff = dnow-date1;
    //    var ONE_DAY = 1000 * 60 * 60 * 24;
    //    console.log(Math.round(datediff/ONE_DAY));
    //    console.log(Date().toString());
        var options = ["food", "leisure", "item", "rent", "insurance"];
        document.getElementById("time").innerHTML = "Today is " + dnow.getDate() + 
                                                     "." + (dnow.getMonth() + 1)  + "." +
                                                     dnow.getFullYear();
        
        document.getElementById("data").innerHTML = data;
        printPurchases();
        calcTotalSpending();
        calcCategorySpendings();
        
        addSelections(options);
        
        $('#commit-button').click(function validateForm() {
            ptime = Date().toString();
            purchase = document.forms["input_sheet"]["purchase"].value;
            price = parseInt(document.forms["input_sheet"]["price"].value);
            selection = document.getElementById("selection")["value"];
            
            if (purchase.length > 0) {
                data.push([purchase, price, selection, ptime]);
            }
            printPurchases();
            calcTotalSpending();
            var categoryspendings = calcCategorySpendings();
            drawChart(categoryspendings);
        });

        function loadData(filename) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open('GET', filename, false); // last param: false=sync
            xmlHttp.send();
            return JSON.parse(xmlHttp.responseText);
        }
        
        function printPurchases(){
            // Print the list of goodies bought
            var arraystr = "<table style=\"width:60%\">";
            arraystr += "<tr><th>Item</th><th>Price</th><th>Type</th><th>Date</th></tr>"
            for (var i=data.length-1;i>-1;i--){
                arraystr += "<tr><td>"
                arraystr += data[i][0];
                arraystr += "</td><td>"
                arraystr += data[i][1];
                arraystr += "</td><td>"
                arraystr += data[i][2];
                arraystr += "</td><td>"
                arraystr +=data[i][3];

                arraystr += "</tr>";
            }
            arraystr += "</table>"
            document.getElementById("data").innerHTML = arraystr;
        }
        
        function calcCategorySpendings(){
            // Calculate (and currently print) categorical spendings for each option
            var categoryspendings = Array(options.length).fill(0);
            for (var i=0;i<options.length;i++){
                for (j=0;j<data.length;j++) {
                    if (options[i].valueOf() == data[j][2].valueOf()) {
                        categoryspendings[i] += data[j][1];
                    }
                }
            }
            spendingstr = "";
            for (var i=0;i<options.length;i++){
                spendingstr += options[i] + ": " + categoryspendings[i] + " ";
            }
            document.getElementById("categoryspending").innerHTML = spendingstr;
            return categoryspendings;
        }
        
         function calcTotalSpending(){
            // Calculate (and currently print) total spending for all products
            spending = 0;
            for (var i=0;i<data.length;i++){
                spending += parseInt(data[i][1]);
            }
            
            document.getElementById("spending").innerHTML = "Total: " + spending;
        }
        
        function addSelections(options){
            //Create and append the options
            for (var i = 0; i < options.length; i++) {
                var option = document.createElement("option");
                option.value = options[i];
                option.text = options[i];
                document.getElementById("selection").appendChild(option);
            }    
        }

        function drawChart(spendings){
            var d = [['Category', 'Spending on category']];
            for (var i = 0; i < options.length; i++){
                d.push([options[i], spendings[i]]);
            }
        
            var data = google.visualization.arrayToDataTable(d);

            var ops = {
              title: 'My spendings'
            };
            var chart = new google.visualization.PieChart(document.getElementById('charts'));
            chart.draw(data, ops);
        }
        
    //    function saveData(filename, data) {
    //        var xmlHttp = new XMLHttpRequest();
      //      xmlHttp.open('SET', filename, false); // last param: false=sync
        //    xmlHttp.send();
      //  }
    }());
    </script>
</body>

</html>